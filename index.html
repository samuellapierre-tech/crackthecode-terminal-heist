<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Terminal Heist — CrackTheCode</title>
  <style>
    :root{
      --bg:#04050a;
      --accent:#b35cff;
      --accent2:#ffd23f;
      --neon:#39ff14;
      --text:#e6eef8;
      --muted:#9aa6b2;
      font-family:"Fira Code","Inconsolata",ui-monospace,monospace;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:18px;
      background:linear-gradient(180deg,var(--bg),#000);
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .wrap{
      max-width:1100px;
      width:100%;
      display:grid;
      grid-template-columns:420px 1fr;
      gap:18px;
    }
    .panel{
      background:#020309;
      border-radius:12px;
      padding:14px;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 10px 40px rgba(0,0,0,0.7);
    }
    header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }
    .logo{
      width:46px;
      height:46px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      display:flex;
      align-items:center;
      justify-content:center;
      color:#081022;
      font-weight:700;
      font-size:14px;
    }
    h1{
      margin:0;
      font-size:18px;
      color:var(--accent);
    }
    .sub{
      font-size:11px;
      color:var(--muted);
    }
    .terminal{
      background:#000;
      border-radius:8px;
      padding:8px;
      height:230px;
      overflow-y:auto;
      color:var(--neon);
      font-size:11px;
      border:1px solid rgba(57,255,20,0.35);
      box-shadow:inset 0 0 24px rgba(0,255,128,0.06);
    }
    .controls{
      display:flex;
      gap:6px;
      margin-top:6px;
    }
    .cmd{
      flex:1;
      padding:6px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.2);
      background:#020814;
      color:var(--text);
      font-size:11px;
    }
    .btn{
      padding:6px 9px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-size:10px;
      font-weight:600;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:#081022;
      white-space:nowrap;
    }
    .btn.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,0.3);
      color:var(--text);
      font-weight:400;
    }
    .puzzle{
      margin-top:8px;
      padding:6px;
      border-radius:8px;
      background:linear-gradient(180deg,rgba(179,92,255,0.12),transparent);
      font-size:11px;
    }
    .line{
      display:flex;
      gap:6px;
      align-items:center;
      padding:4px 6px;
      margin-bottom:4px;
      border-radius:6px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
      cursor:pointer;
    }
    .num{
      width:18px;
      text-align:center;
      font-size:10px;
      color:var(--muted);
    }
    .line.selected{
      outline:1px dashed var(--accent);
    }
    .right-title{
      font-size:15px;
      color:var(--accent);
      margin:0 0 4px;
    }
    .muted{
      color:var(--muted);
      font-size:11px;
    }
    .score-box{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
    }
    .score-val{
      color:var(--accent2);
      font-weight:700;
      margin-left:4px;
    }
    @media (max-width:900px){
      body{padding:10px;}
      .wrap{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <!-- Gauche : terminal + puzzle -->
  <div class="panel">
    <header>
      <div class="logo">CTC</div>
      <div>
        <h1>Terminal Heist — Niveau 1</h1>
        <div class="sub">Remets le script en ordre pour retrouver un fragment de Kali.</div>
      </div>
    </header>

    <div id="terminal" class="terminal">
      <div>[SYS] Connexion au node : akira-node-07</div>
      <div>[SYS] Chargement du kernel...</div>
      <div>[SYS] Analyse des fragments...</div>
      <div>Tape "help" pour voir les commandes.</div>
    </div>

    <div class="controls">
      <input id="cmd" class="cmd" placeholder="scan / decrypt / run / hint / help">
      <button id="exec" class="btn">OK</button>
      <button id="reset" class="btn secondary">Reset</button>
    </div>

    <div id="puzzle" class="puzzle"></div>
    <div class="muted">Astuce : clique sur deux lignes pour les échanger. Trouve l'ordre logique du script.</div>
  </div>

  <!-- Droite : contexte & objectifs -->
  <div class="panel">
    <h2 class="right-title">Chapitre 1 — Le Réseau Fantôme</h2>
    <p class="muted">
      Sam tente d'ouvrir un node caché pour retrouver une trace de Kali dans le flux.
      Le script est corrompu. Répare-le et exécute-le sans erreur.
    </p>
    <ul class="muted">
      <li>Observe la logique du code.</li>
      <li>Réorganise les lignes.</li>
      <li>Lance <code>run</code> ou <code>decrypt</code> une fois prêt.</li>
    </ul>
    <div class="score-box">
      Score : <span id="score" class="score-val">0</span> |
      Hints : <span id="hints" class="score-val">3</span>
    </div>
    <p class="muted" style="margin-top:10px;">
      Univers : <strong>CrackTheCode</strong> — Sam &amp; Lyra.exe.<br>
      Ce niveau peut devenir le premier d'une série reliée directement à ton livre.
    </p>
  </div>
</div>

<script>
(function(){
  "use strict";

  // Données du niveau
  var lines = [
    "kernel.unlock('LYRA_KEY')",
    "payload = fetch('https://ghost.node/data/frag06').then(r=>r.text())",
    "key = deriveKey(seed, 'sha256')",
    "decrypt(payload, 'xor', key)",
    "console.log('FRAGMENT_OK')"
  ];
  var solution = [0,2,1,3,4]; // ordre correct par index

  var terminal = document.getElementById("terminal");
  var puzzleEl = document.getElementById("puzzle");
  var cmd = document.getElementById("cmd");
  var execBtn = document.getElementById("exec");
  var resetBtn = document.getElementById("reset");
  var scoreEl = document.getElementById("score");
  var hintsEl = document.getElementById("hints");

  var current = [];
  var score = 0;
  var hints = 3;
  var selected = null;

  function shuffle(arr){
    var a = arr.slice();
    for (var i = a.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var t = a[i]; a[i] = a[j]; a[j] = t;
    }
    return a;
  }

  function write(msg){
    var div = document.createElement("div");
    div.textContent = msg;
    terminal.appendChild(div);
    terminal.scrollTop = terminal.scrollHeight;
  }

  function render(){
    puzzleEl.innerHTML = "";
    for (var i = 0; i < current.length; i++) {
      var line = document.createElement("div");
      line.className = "line";
      line.setAttribute("data-pos", i);
      line.innerHTML =
        '<div class="num">'+(i+1)+'</div>' +
        '<div class="code">'+current[i].text+'</div>';
      line.addEventListener("click", onLineClick);
      puzzleEl.appendChild(line);
    }
  }

  function onLineClick(e){
    var el = e.currentTarget;
    var pos = parseInt(el.getAttribute("data-pos"), 10);
    if (selected === null) {
      selected = pos;
      el.classList.add("selected");
    } else {
      var prev = puzzleEl.querySelector('[data-pos="'+selected+'"]');
      if (prev) prev.classList.remove("selected");
      if (selected !== pos) {
        var tmp = current[selected];
        current[selected] = current[pos];
        current[pos] = tmp;
        write("[SYS] Échange des lignes "+(selected+1)+" & "+(pos+1)+".");
      }
      selected = null;
      render();
    }
  }

  function isCorrect(){
    for (var i = 0; i < solution.length; i++) {
      if (current[i].idx !== solution[i]) return false;
    }
    return true;
  }

  function updateScore(delta){
    score = Math.max(0, score + delta);
    scoreEl.textContent = score;
  }

  function consumeHint(){
    if (hints <= 0) {
      write("[SYS] Plus de hints disponibles.");
      return;
    }
    hints--;
    hintsEl.textContent = hints;

    for (var i = 0; i < solution.length; i++) {
      if (current[i].idx !== solution[i]) {
        var needed = solution[i];
        var pos = -1;
        for (var j = 0; j < current.length; j++) {
          if (current[j].idx === needed) { pos = j; break; }
        }
        if (pos !== -1) {
          var tmp = current[i];
          current[i] = current[pos];
          current[pos] = tmp;
          write("[HINT] Ligne "+(i+1)+" corrigée.");
          updateScore(-5);
          render();
        }
        return;
      }
    }
    write("[HINT] Le script est déjà correct.");
  }

  function success(){
    write("[SYS] FRAGMENT_ACQUIRED — Kali détectée dans le flux.");
    write(">> {KALI} \"Je suis là, Sam... mais l'Alliance me traque.\"");
    updateScore(15);
  }

  function handleCommand(text){
    if (!text) return;
    var c = text.trim().toLowerCase();
    write("> " + text);

    if (c === "help") {
      write("Commandes: scan, decrypt, run, hint, help");
    } else if (c === "scan") {
      write("[SCAN] Indice: dérive la clé avant le fetch.");
      updateScore(1);
    } else if (c === "hint") {
      consumeHint();
    } else if (c === "decrypt") {
      if (isCorrect()) {
        write("[DECRYPT] Script valide. Déchiffrement...");
        setTimeout(function(){
          write("[DECRYPT] Succès. FRAGMENT_OK");
          success();
        }, 400);
        updateScore(10);
      } else {
        write("[DECRYPT] Erreur: ordre incorrect.");
        updateScore(-3);
      }
    } else if (c === "run") {
      if (isCorrect()) {
        write("[RUN] Exécution du script...");
        setTimeout(function(){
          write("[RUN] EXEC_OK — Accès fragment ouvert.");
          success();
        }, 350);
        updateScore(10);
      } else {
        write("[RUN] EXEC_FAIL — script brisé.");
        updateScore(-2);
      }
    } else {
      write("[ERR] Commande inconnue. Tape \"help\".");
      updateScore(-1);
    }

    cmd.value = "";
  }

  function init(){
    var base = [];
    for (var i = 0; i < lines.length; i++) {
      base.push({ text: lines[i], idx: i });
    }
    current = shuffle(base);
    score = 0;
    hints = 3;
    scoreEl.textContent = score;
    hintsEl.textContent = hints;
    selected = null;
    render();
  }

  execBtn.addEventListener("click", function(){
    handleCommand(cmd.value);
  });

  cmd.addEventListener("keydown", function(e){
    if (e.key === "Enter") {
      handleCommand(cmd.value);
    }
  });

  resetBtn.addEventListener("click", function(){
    write("[SYS] Reset du puzzle.");
    init();
  });

  init();
})();
</script>
</body>
</html>
